                                        <p><i>This is the fourth in a series of entries about the SPARQL calendar demo. If you haven't already, you can read the <a href="http://www.thefigtrees.net/lee/blog/2006/03/sparql_calendar_demo_stepbyste.html">previous entry</a>.</i></p>

<p>A key component of the calendar demo is our <a href="http://www.thefigtrees.net/lee/sw/sparql.js">SPARQL JavaScript library</a>. Leigh Dodds <a href="http://www.ldodds.com/blog/archives/000255.html">blogged</a> about his <a href="http://xmlarmyknife.org/js/sparql.js">SPARQL AJAX client</a> a few months back. As one of our motivations for the calendar demo was to explore the JSON serialization of SPARQL queries, though, we whipped up our own library for SPARQL queries. This library features:</p>

<ul>
<li>...issuing SPARQL SELECT or ASK queries using the <a href="http://www.w3.org/TR/rdf-sparql-protocol/">SPARQL Protocol for RDF</a> extended with a parameter named <code>output</code>. <a href="http://www.joseki.org/">Joseki</a> as deployed on <a href="http://sparql.org">SPARQLer</a> currently supports:</li>
  <ul>
    <li>No <code>output</code> specified; results are returned in the <a href="http://www.w3.org/TR/rdf-sparql-XMLres/">SPARQL Query Results XML Format</a> with a MIME type of <code>application/sparql-results+xml</code>.</li>
    <li><code>output=xml</code> or <code>output=sparql</code>; results are returned in the SPARQL Query Results XML Format with a MIME type of <code>text/plain</code>.</li>
    <li><code>output=json</code>; results are returned via the <a href="http://www.w3.org/TR/rdf-sparql-json-res/">JSON serialization</a> with a MIME type of <code>text/javascript</code>.</li>
    <li><code>output=</code><i>any-other-value</i>; results are returned in RDF/XML with MIME type <code>text/plain</code> as a graph using the DAWG's <a href="http://www.w3.org/2001/sw/DataAccess/tests/result-set">result-set vocabulary</a> for test cases.</li>
  </ul>
<li>...automatically validating and parsing JSON return values into JavaScript objects.</li>
<li>...providing several query wrapper methods and accompanying result transformations to enable direct access to single-valued query results, vectors of query results, and boolean results (for ASK queries). This mechanism could be easily extended to support parsing the XML result format.</li>
<li>...allowing either HTTP GET or HTTP POST to be used when sending queries.</li>
<li>...providing distinct service and query objects such that dataset graphs, prefixes, and other settings can be set service-wide or on a per-query basis.</li>
</ul>

<p>The library currently has an unmotivated dependency on the <a href="http://developer.yahoo.com/yui/connection/index.html">Yahoo! connection manager</a>, but this dependency could (and likely will) be easily removed.</p>

<p>Finally, some example usages of the library's API:</p>

<pre>var sparqler = new SPARQL.Service("http://sparql.org/sparql");

// graphs and prefixes defined here
// are inherited by all future queries
sparqler.addDefaultGraph("http://thefigtrees.net/lee/ldf-card");
sparqler.addNamedGraph("http://torrez.us/elias/foaf.rdf");
sparqler.setPrefix("foaf", "http://xmlns.com/foaf/0.1/"); 
sparqler.setPrefix("rdf", "http://www.w3.org/1999/02/22-rdf-syntax-ns#");
	
// "json" is the default output format
sparqler.setOutput("json");

var query = sparqler.createQuery();

// these settings are for this query only
query.addDefaultGraph(...);
query.addNamedGraph(...);
query.setPrefix(...);

// query wrappers:

// passes standard JSON results object to success callback
query.setPrefix("ldf", "http://thefigtrees.net/lee/ldf-card#");
query.query(
  "SELECT ?who ?mbox WHERE { ldf:LDF foaf:knows ?who . ?who foaf:mbox ?mbox }",
  {failure: onFailure, success: function(json) { for (var x in json.head.vars) { ... } ...}}
);

// passes boolean value to success callback
query.ask(
  "ASK ?person WHERE { ?person foaf:knows [ foaf:name "Dan Connolly" ] }",
  {failure: onFailure, success: function(bool) { if (bool) ... }}
); 

// passes a single vector (array) of values 
// representing a single column of results 
// to success callback
query.setPrefix("ldf", "http://thefigtrees.net/lee/ldf-card#");
var addresses = query.selectValues(
  "SELECT ?mbox WHERE { _:someone foaf:mbox ?mbox }",
  {failure: onFailure, success: function(values) { for (var i = 0; i &lt; values.length; i++) { ... values[i] ...} } }
); 

// passes a single value representing a single 
// row of a single column (variable) to success callback
query.setPrefix("ldf", "http://thefigtrees.net/lee/ldf-card#");
var myAddress = query.selectSingleValue(
  "SELECT ?mbox WHERE {ldf:LDF foaf:mbox ?mbox }",
  {failure: onFailure, success: function(value) { alert("value is: " + value); } }
); 
	
// shortcuts for all of the above 
// (w/o ability to set any query-specific graphs or prefixes)
sparqler.query(...);
sparqler.ask(...);
sparqler.selectValues(...);
sparqler.selectSingleValue(...);
</pre>

<p>Feel free to <a href="http://thefigtrees.net/lee/sw/demos/calendar/resources/sparql/sparql.js">download</a> and use the library as you see fit. I'll post here when there's any substantive updates to it. In the next entry, I'll start delving into the specific SPARQL queries that drive the calendar demo.</p>
